import React, { useState } from 'react';
import * as XLSX from 'xlsx';

const JamfDeviceUserMatcher = () => {
  const [serials, setSerials] = useState([]);
  const [users, setUsers] = useState([]);
  const [assignments, setAssignments] = useState([]);
  const [matches, setMatches] = useState([]);
  const [stats, setStats] = useState({ matched: 0, notFound: 0 });

  const parseCSV = text => {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];
    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    return lines.slice(1).map(line => {
      const values = line.split(',');
      const obj = {};
      headers.forEach((h, i) => obj[h] = (values[i] || '').trim());
      return obj;
    });
  };

  const parseExcel = buffer => {
    const wb = XLSX.read(buffer, { type: 'array' });
    const ws = wb.Sheets[wb.SheetNames[0]];
    const data = XLSX.utils.sheet_to_json(ws, { header: 1 });
    if (data.length < 2) return [];
    const headers = data[0].map(h => String(h).trim().toLowerCase());
    return data.slice(1).map(row => {
      const obj = {};
      headers.forEach((h, i) => obj[h] = row[i] ? String(row[i]).trim() : '');
      return obj;
    });
  };

  const handleUpload = (e, type) => {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
    reader.onload = event => {
      const data = isExcel ? parseExcel(event.target.result) : parseCSV(event.target.result);
      if (type === 'serials') setSerials(data);
      else if (type === 'users') setUsers(data);
      else if (type === 'assignments') setAssignments(data);
    };
    isExcel ? reader.readAsArrayBuffer(file) : reader.readAsText(file);
  };

  const performMatching = () => {
    if (!serials.length || !users.length || !assignments.length) return;
    const serialMap = new Map(serials.map(s => [(s.serialnumber || s.serial || '').toUpperCase(), s]));
    const userMap = new Map(users.map(u => [(u.username || u.user || '').toLowerCase(), u]));
    let matched = 0, notFound = 0;
    const results = assignments.map((a, i) => {
      const s = (a.serialnumber || a.serial || '').toUpperCase();
      const u = (a.username || a.user || '').toLowerCase();
      let status = 'not_found';
      if (s && serialMap.has(s) && u && userMap.has(u)) { status = 'matched'; matched++; }
      else { notFound++; }
      return { id: i, serial: s, user: u, status };
    });
    setMatches(results);
    setStats({ matched, notFound });
  };

  return (
    <div style={{ padding: '20px', maxWidth: '800px', margin: 'auto' }}>
      <h2>Jamf Benutzer-Gerätezuordnung</h2>

      <div style={{ display: 'flex', gap: '10px', margin: '10px 0' }}>
        <input type="file" onChange={e => handleUpload(e, 'serials')} />
        <input type="file" onChange={e => handleUpload(e, 'users')} />
        <input type="file" onChange={e => handleUpload(e, 'assignments')} />
      </div>

      <button onClick={performMatching} style={{ marginBottom: '10px' }}>Matching durchführen</button>

      {matches.length > 0 && (
        <>
          <div style={{ marginBottom: '10px' }}>
            Erfolgreich: {stats.matched} | Nicht gefunden: {stats.notFound} | Gesamt: {matches.length}
          </div>

          <table border="1" cellPadding="5" cellSpacing="0" style={{ width: '100%' }}>
            <thead>
              <tr>
                <th>Status</th>
                <th>Serial</th>
                <th>User</th>
              </tr>
            </thead>
            <tbody>
              {matches.map(m => (
                <tr key={m.id} style={{ background: m.status === 'matched' ? '#d4f4dd' : '#f8d7da' }}>
                  <td>{m.status}</td>
                  <td>{m.serial || '-'}</td>
                  <td>{m.user || '-'}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </>
      )}
    </div>
  );
};

export default JamfDeviceUserMatcher;
