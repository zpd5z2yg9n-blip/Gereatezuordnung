<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jamf Matcher Test</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-gray-50 p-6">
<div id="root"></div>

<script type="text/babel">
const { useState } = React;

const JamfDeviceUserMatcher = () => {
  const [serials,setSerials] = useState([]);
  const [users,setUsers] = useState([]);
  const [schools,setSchools] = useState([]);
  const [matches,setMatches] = useState([]);

  const parseCSV = text => {
    const lines = text.trim().split('\n');
    if(lines.length<2) return [];
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    return lines.slice(1).filter(l=>l.trim()).map(line=>{
      const values=line.split(',').map(v=>v.trim());
      const obj={};
      headers.forEach((h,i)=>obj[h]=values[i]||'');
      return obj;
    });
  };

  const handleFile = (e,type)=>{
    const f=e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const data = parseCSV(ev.target.result);
      if(type==='serials') setSerials(data);
      else if(type==='users') setUsers(data);
      else if(type==='schools') setSchools(data);
    };
    reader.readAsText(f);
  };

  const match = ()=>{
    const results = [];
    const serialMap = new Map(serials.map(s=>[(s.serialnumber||s.serial||s.seriennummer||'').toUpperCase(),s]));
    const userMap = new Map(users.map(u=>[(u.username||u.user||u.benutzername||'').toLowerCase(),u]));

    schools.forEach((s,i)=>{
      const serial = (s.serialnumber||s.serial||s.seriennummer||'').toUpperCase();
      const user = (s.username||s.user||s.benutzername||'').toLowerCase();
      let status='not found';
      if(serialMap.has(serial) && userMap.has(user)) status='matched';
      results.push({id:i,serial,user,status});
    });
    setMatches(results);
  };

  return (
    <div>
      <h1 className="text-xl font-bold mb-4">Jamf Matcher Test</h1>
      <div className="grid grid-cols-3 gap-2 mb-4">
        <input type="file" onChange={e=>handleFile(e,'serials')} className="border p-2"/>
        <input type="file" onChange={e=>handleFile(e,'users')} className="border p-2"/>
        <input type="file" onChange={e=>handleFile(e,'schools')} className="border p-2"/>
      </div>
      <button onClick={match} className="px-4 py-2 bg-blue-600 text-white rounded">Match</button>
      {matches.length>0 && (
        <table className="mt-4 w-full border-collapse border">
          <thead>
            <tr className="bg-gray-200"><th>Serial</th><th>User</th><th>Status</th></tr>
          </thead>
          <tbody>
            {matches.map(m=>(
              <tr key={m.id} className="border"><td>{m.serial}</td><td>{m.user}</td><td>{m.status}</td></tr>
            ))}
          </tbody>
        </table>
      )}
    </div>
  );
};

ReactDOM.createRoot(document.getElementById('root')).render(<JamfDeviceUserMatcher />);
</script>
</body>
</html>
