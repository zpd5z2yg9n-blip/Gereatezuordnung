<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>Jamf Matcher</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://unpkg.com/react@18/umd/react.development.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
</head>
<body class="bg-gray-50 p-6">
<div id="root"></div>

<script type="text/babel">
const { useState } = React;

const IconCheck = () => <span className="text-green-600 font-bold">&#10003;</span>;
const IconCross = () => <span className="text-red-600 font-bold">&#10007;</span>;

const JamfDeviceUserMatcher = () => {
  const [serials, setSerials] = useState([]);
  const [users, setUsers] = useState([]);
  const [school, setSchool] = useState([]);
  const [matches, setMatches] = useState([]);
  const [stats, setStats] = useState({ matched:0, notFound:0 });

  const parseCSV = text => {
    const lines = text.trim().split("\n");
    if(lines.length < 2) return [];
    const headers = lines[0].split(',').map(h=>h.trim().toLowerCase());
    return lines.slice(1).map(line=>{
      const vals = line.split(',').map(v=>v.trim());
      const obj = {}; headers.forEach((h,i)=>obj[h]=vals[i]||''); return obj;
    });
  }

  const parseExcel = arrayBuffer => {
    try{
      const wb = XLSX.read(arrayBuffer,{type:'array'});
      const ws = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]],{header:1});
      const headers = ws[0].map(h=>String(h).trim().toLowerCase());
      return ws.slice(1).map(r=>{
        const obj = {}; headers.forEach((h,i)=>obj[h]=r[i]?String(r[i]).trim():''); return obj;
      });
    }catch(e){alert('Excel Fehler'); return [];}
  }

  const handleUpload = (e,type)=>{
    const f = e.target.files[0]; if(!f) return;
    const r = new FileReader();
    const excel = f.name.endsWith('.xls')||f.name.endsWith('.xlsx');
    r.onload = ev => {
      const data = excel?parseExcel(ev.target.result):parseCSV(ev.target.result);
      if(type==='serials') setSerials(data);
      else if(type==='users') setUsers(data);
      else setSchool(data);
    }
    excel?r.readAsArrayBuffer(f):r.readAsText(f);
  }

  const doMatch = ()=>{
    if(!serials.length||!users.length||!school.length){alert('Alle drei Dateien hochladen!'); return;}
    const sMap = new Map(serials.map(i=>[(i.serialnumber||i.serial||i.seriennummer||'').toUpperCase(),i]));
    const uMap = new Map(users.map(i=>[(i.username||i.user||i.benutzername||'').toLowerCase(),i]));
    let m=0, nf=0;
    const res = school.map((a,i)=>{
      const s = (a.serialnumber||a.serial||a.seriennummer||'').toUpperCase();
      const u = (a.username||a.user||a.benutzername||'').t
