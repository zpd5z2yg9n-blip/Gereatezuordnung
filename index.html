import React, { useState } from 'react';
import { Upload, Download, CheckCircle, XCircle, AlertTriangle, Users, Tablet, Link, FileText } from 'lucide-react';
import * as XLSX from 'xlsx';

const JamfDeviceUserMatcher = () => {
  const [serialNumbers, setSerialNumbers] = useState([]);
  const [usernames, setUsernames] = useState([]);
  const [schoolAssignments, setSchoolAssignments] = useState([]);
  const [schoolFiles, setSchoolFiles] = useState([]);
  const [matches, setMatches] = useState([]);
  const [stats, setStats] = useState({ matched: 0, notFound: 0, ambiguous: 0 });

  const parseCSV = (text) => {
    const lines = text.trim().split('\n');
    if (lines.length < 2) return [];

    const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
    return lines.slice(1)
      .filter(line => line.trim())
      .map(line => {
        const values = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((header, i) => {
          obj[header] = values[i] || '';
        });
        return obj;
      });
  };

  const parseExcel = (arrayBuffer) => {
    try {
      const workbook = XLSX.read(arrayBuffer, { type: 'array' });
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });

      if (jsonData.length < 2) return [];
      
      const headers = jsonData[0].map(h => String(h).trim().toLowerCase());
      return jsonData.slice(1)
        .filter(row => row.some(cell => cell !== undefined && cell !== ''))
        .map(row => {
          const obj = {};
          headers.forEach((header, i) => {
            obj[header] = row[i] ? String(row[i]).trim() : '';
          });
          return obj;
        });
    } catch (error) {
      console.error('Excel parsing error:', error);
      alert('Fehler beim Lesen der Excel-Datei. Bitte Datei prüfen.');
      return [];
    }
  };

  const handleFileUpload = (event, type) => {
    const files = type === 'school' ? Array.from(event.target.files) : [event.target.files[0]];
    if (files.length === 0) return;

    if (type === 'school') {
      let allSchoolData = [];
      let filesProcessed = 0;
      const fileNames = [];

      files.forEach((file, index) => {
        const reader = new FileReader();
        const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
        
        fileNames.push(file.name);
        
        if (isExcel) {
          reader.onload = (e) => {
            const data = parseExcel(e.target.result);
            allSchoolData = [...allSchoolData, ...data];
            filesProcessed++;
            
            if (filesProcessed === files.length) {
              setSchoolAssignments(allSchoolData);
              setSchoolFiles(fileNames);
            }
          };
          reader.readAsArrayBuffer(file);
        } else {
          reader.onload = (e) => {
            const data = parseCSV(e.target.result);
            allSchoolData = [...allSchoolData, ...data];
            filesProcessed++;
            
            if (filesProcessed === files.length) {
              setSchoolAssignments(allSchoolData);
              setSchoolFiles(fileNames);
            }
          };
          reader.readAsText(file);
        }
      });
    } else {
      const file = files[0];
      const reader = new FileReader();
      const isExcel = file.name.endsWith('.xlsx') || file.name.endsWith('.xls');
      
      if (isExcel) {
        reader.onload = (e) => {
          const data = parseExcel(e.target.result);
          
          if (type === 'serials') {
            setSerialNumbers(data);
          } else if (type === 'users') {
            setUsernames(data);
          }
        };
        reader.readAsArrayBuffer(file);
      } else {
        reader.onload = (e) => {
          const data = parseCSV(e.target.result);
          
          if (type === 'serials') {
            setSerialNumbers(data);
          } else if (type === 'users') {
            setUsernames(data);
          }
        };
        reader.readAsText(file);
      }
    }
  };

  const performMatching = () => {
    if (!serialNumbers.length || !usernames.length || !schoolAssignments.length) {
      alert('Bitte alle drei CSV-Dateien hochladen!');
      return;
    }

    const results = [];
    let matched = 0;
    let notFound = 0;
    let ambiguous = 0;

    const serialMap = new Map();
    serialNumbers.forEach(item => {
      const serial = (item.serialnumber || item.serial || item.seriennummer || '').toUpperCase();
      if (serial) serialMap.set(serial, item);
    });

    const userMap = new Map();
    usernames.forEach(item => {
      const user = (item.username || item.user || item.benutzername || '').toLowerCase();
      if (user) userMap.set(user, item);
    });

    schoolAssignments.forEach((assignment, index) => {
      const assignedSerial = (
        assignment.serialnumber || 
        assignment.serial || 
        assignment.seriennummer ||
        assignment['serial number'] ||
        ''
      ).toUpperCase();
      
      const assignedUser = (
        assignment.username || 
        assignment.user || 
        assignment.benutzername ||
        assignment.schüler ||
        assignment.student ||
        ''
      ).toLowerCase();

      let status = 'unknown';
      let message = '';
      let foundSerial = null;
      let foundUser = null;

      if (assignedSerial && serialMap.has(assignedSerial)) {
        foundSerial = serialMap.get(assignedSerial);
      } else if (assignedSerial) {
        status = 'serial_not_found';
        message = `Seriennummer ${assignedSerial} nicht in Jamf gefunden`;
        notFound++;
      }

      if (assignedUser && userMap.has(assignedUser)) {
        foundUser = userMap.get(assignedUser);
      } else if (assignedUser) {
        status = 'user_not_found';
        message = `Benutzer ${assignedUser} nicht in Jamf gefunden`;
        notFound++;
      }

      if (foundSerial && foundUser) {
        status = 'matched';
        message = 'Match gefunden';
        matched++;
      } else if (!assignedSerial && !assignedUser) {
        status = 'empty';
        message = 'Leere Zeile';
        notFound++;
      }

      results.push({
        id: index,
        originalSerial: assignedSerial,
        originalUser: assignedUser,
        jamfSerial: foundSerial,
        jamfUser: foundUser,
        status,
        message,
        ...assignment
      });
    });

    setMatches(results);
    setStats({ matched, notFound, ambiguous });
  };

  const exportMatches = () => {
    const validMatches = matches.filter(m => m.status === 'matched');

    if (validMatches.length === 0) {
      alert('Keine gültigen Matches zum Exportieren gefunden!');
      return;
    }

    const headers = 'Serial Number,Identification,Username';
    const rows = validMatches.map(match => 
      `${match.originalSerial},${match.originalSerial},${match.originalUser}`
    );

    const csv = [headers, ...rows].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `Jamf_User_Assignment_${new Date().toISOString().split('T')[0]}.csv`;
    link.click();
  };

  const getStatusIcon = (status) => {
    switch(status) {
      case 'matched':
        return <CheckCircle className="text-green-600" size={20} />;
      case 'serial_not_found':
      case 'user_not_found':
      case 'empty':
        return <XCircle className="text-red-600" size={20} />;
      case 'ambiguous':
        return <AlertTriangle className="text-yellow-600" size={20} />;
      default:
        return <AlertTriangle className="text-gray-400" size={20} />;
    }
  };

  const getStatusColor = (status) => {
    switch(status) {
      case 'matched':
        return 'bg-green-50 border-green-200';
      case 'serial_not_found':
      case 'user_not_found':
      case 'empty':
        return 'bg-red-50 border-red-200';
      default:
        return 'bg-gray-50 border-gray-200';
    }
  };

  return (
    <div className="min-h-screen bg-gray-50 p-6">
      <div className="max-w-7xl mx-auto">
        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
          <div className="flex flex-col items-center mb-6">
            <svg className="w-8 h-8 mb-3 opacity-60" viewBox="0 0 24 24" fill="currentColor">
              <path d="M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z" fill="#2c3e50"/>
            </svg>
            <h1 className="text-xl font-bold text-gray-800 mb-1">Jamf Benutzer-Gerätezuordnung</h1>
            <p className="text-sm text-gray-600 mb-2">Automatisches Matching von Seriennummern und Benutzernamen</p>
            <div className="text-center">
              <div className="text-xs font-medium text-gray-500">Powered by</div>
              <div className="text-sm font-bold text-blue-600">Jamf School Tech</div>
            </div>
          </div>

          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-500 transition-colors">
              <label className="cursor-pointer">
                <div className="flex flex-col items-center gap-2">
                  <Tablet className="text-gray-400" size={32} />
                  <span className="font-medium text-gray-700">Seriennummern (Jamf)</span>
                  <span className="text-sm text-gray-500">
                    {serialNumbers.length > 0 ? `${serialNumbers.length} Einträge` : 'CSV hochladen'}
                  </span>
                </div>
                <input
                  type="file"
                  accept=".csv"
                  onChange={(e) => handleFileUpload(e, 'serials')}
                  className="hidden"
                />
              </label>
            </div>

            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-500 transition-colors">
              <label className="cursor-pointer">
                <div className="flex flex-col items-center gap-2">
                  <Users className="text-gray-400" size={32} />
                  <span className="font-medium text-gray-700">Benutzernamen (Jamf)</span>
                  <span className="text-sm text-gray-500">
                    {usernames.length > 0 ? `${usernames.length} Einträge` : 'CSV hochladen'}
                  </span>
                </div>
                <input
                  type="file"
                  accept=".csv"
                  onChange={(e) => handleFileUpload(e, 'users')}
                  className="hidden"
                />
              </label>
            </div>

            <div className="border-2 border-dashed border-gray-300 rounded-lg p-4 hover:border-blue-500 transition-colors">
              <label className="cursor-pointer">
                <div className="flex flex-col items-center gap-2">
                  <FileText className="text-gray-400" size={32} />
                  <span className="font-medium text-gray-700">Schul-Zuordnung</span>
                  <span className="text-sm text-gray-500">
                    {schoolAssignments.length > 0 
                      ? `${schoolAssignments.length} Einträge (${schoolFiles.length} Dateien)` 
                      : 'CSV/Excel hochladen'}
                  </span>
                  {schoolFiles.length > 0 && (
                    <div className="text-xs text-gray-400 mt-1 max-w-full overflow-hidden">
                      {schoolFiles.map((name, idx) => (
                        <div key={idx} className="truncate">• {name}</div>
                      ))}
                    </div>
                  )}
                </div>
                <input
                  type="file"
                  accept=".csv,.xlsx,.xls"
                  multiple
                  onChange={(e) => handleFileUpload(e, 'school')}
                  className="hidden"
                />
              </label>
            </div>
          </div>

          <div className="flex gap-4">
            <button
              onClick={performMatching}
              disabled={!serialNumbers.length || !usernames.length || !schoolAssignments.length}
              className="flex items-center gap-2 px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
            >
              <Link size={20} />
              Matching durchführen
            </button>
            
            {matches.length > 0 && (
              <button
                onClick={exportMatches}
                disabled={stats.matched === 0}
                className="flex items-center gap-2 px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 disabled:bg-gray-300 disabled:cursor-not-allowed transition-colors"
              >
                <Download size={20} />
                CSV für Benutzerzuordnung erstellen ({stats.matched})
              </button>
            )}
          </div>
        </div>

        {matches.length > 0 && (
          <div className="grid grid-cols-3 gap-4 mb-6">
            <div className="bg-green-50 border border-green-200 rounded-lg p-4">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-green-700">{stats.matched}</div>
                  <div className="text-sm text-green-600">Erfolgreich gematcht</div>
                </div>
                <CheckCircle className="text-green-600" size={32} />
              </div>
            </div>

            <div className="bg-red-50 border border-red-200 rounded-lg p-4">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-red-700">{stats.notFound}</div>
                  <div className="text-sm text-red-600">Nicht gefunden</div>
                </div>
                <XCircle className="text-red-600" size={32} />
              </div>
            </div>

            <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
              <div className="flex items-center justify-between">
                <div>
                  <div className="text-2xl font-bold text-blue-700">{matches.length}</div>
                  <div className="text-sm text-blue-600">Gesamt geprüft</div>
                </div>
                <FileText className="text-blue-600" size={32} />
              </div>
            </div>
          </div>
        )}

        {matches.length > 0 && (
          <div className="bg-white rounded-lg shadow-lg p-6">
            <h2 className="text-xl font-bold text-gray-800 mb-4">Matching-Ergebnisse</h2>
            <div className="overflow-x-auto">
              <table className="w-full border-collapse">
                <thead>
                  <tr className="bg-gray-100">
                    <th className="px-4 py-2 text-left text-sm font-medium text-gray-700 border">Status</th>
                    <th className="px-4 py-2 text-left text-sm font-medium text-gray-700 border">Serial Number</th>
                    <th className="px-4 py-2 text-left text-sm font-medium text-gray-700 border">Identification</th>
                    <th className="px-4 py-2 text-left text-sm font-medium text-gray-700 border">Username</th>
                    <th className="px-4 py-2 text-left text-sm font-medium text-gray-700 border">Nachricht</th>
                  </tr>
                </thead>
                <tbody>
                  {matches.map((match) => (
                    <tr key={match.id} className={getStatusColor(match.status)}>
                      <td className="px-4 py-2 border">
                        <div className="flex items-center gap-2">
                          {getStatusIcon(match.status)}
                        </div>
                      </td>
                      <td className="px-4 py-2 border font-mono text-sm">
                        {match.originalSerial || '-'}
                      </td>
                      <td className="px-4 py-2 border font-mono text-sm text-gray-500">
                        {match.originalSerial || '-'}
                      </td>
                      <td className="px-4 py-2 border font-mono text-sm">
                        {match.originalUser || '-'}
                      </td>
                      <td className="px-4 py-2 border text-sm">
                        {match.message}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        )}

        <div className="bg-blue-50 border border-blue-200 rounded-lg p-4 mt-6">
          <div className="flex items-start gap-2">
            <AlertTriangle className="text-blue-600 mt-0.5" size={20} />
            <div className="text-sm text-blue-800">
              <strong>So funktioniert's:</strong>
              <ol className="mt-2 space-y-1 ml-4 list-decimal">
                <li>Lade die CSV-Dateien aus Jamf hoch (Seriennummern + Benutzernamen)</li>
                <li>Lade die Schul-Zuordnung hoch - <strong>mehrere Dateien möglich!</strong> (z.B. pro Klasse)</li>
                <li>Klicke auf "Matching durchführen"</li>
                <li>Prüfe die Ergebnisse - grüne Zeilen sind erfolgreiche Matches</li>
                <li>Exportiere die Matches als CSV für Jamf Import</li>
              </ol>
              <div className="mt-3">
                <strong>Erkannte Spalten:</strong> SerialNumber/Serial/Seriennummer + Username/User/Benutzername/Schüler/Student
              </div>
              <div className="mt-2">
                <strong>Unterstützte Formate:</strong> CSV, Excel (.xlsx, .xls) - Mehrfach-Upload für Schul-Zuordnung möglich
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};

export default JamfDeviceUserMatcher;
